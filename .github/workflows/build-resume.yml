name: Build Resume (TinyTeX Optimized)

permissions:
  contents: write  # Required for creating releases
  pages: write
  id-token: write

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Emacs
      uses: purcell/setup-emacs@master
      with:
        version: 29.1
        
    - name: Cache TinyTeX and packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.TinyTeX
          ~/bin
        key: ${{ runner.os }}-tinytex-${{ hashFiles('**/resume.org', '**/cover-letter.org') }}
        restore-keys: |
          ${{ runner.os }}-tinytex-
          
    - name: Install TinyTeX
      run: |
        # Install TinyTeX (much smaller than full TeXLive)
        wget -qO- "https://yihui.org/tinytex/install-bin-unix.sh" | sh
        echo "$HOME/bin" >> $GITHUB_PATH
        export PATH="$HOME/bin:$PATH"
        
        # Install only the packages we actually need
        tlmgr install \
          geometry xcolor titlesec enumitem fontawesome5 \
          tools amsfonts fancyhdr lm \
          amsmath hyperref graphics wrapfig \
          ulem capt-of latex-bin \
          latex epstopdf-pkg etoolbox

        tlmgr install collection-fontsrecommended collection-latexrecommended collection-latexextra
          
        # Enable automatic package installation for missing packages
        tlmgr option autobackup 0
        echo 'main_memory=5000000' >> ~/.TinyTeX/texmf.cnf
          
    - name: Cache Emacs packages
      uses: actions/cache@v4
      with:
        path: ~/.emacs.d/elpa
        key: ${{ runner.os }}-emacs-${{ hashFiles('**/resume.org') }}
        restore-keys: |
          ${{ runner.os }}-emacs-
          
    - name: Install org-mode and dependencies
      run: |
        emacs --batch --eval "(require 'package)" \
              --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
              --eval "(package-initialize)" \
              --eval "(package-refresh-contents)" \
              --eval "(package-install 'org)" \
              --eval "(require 'ox-latex)" \
              --eval "(require 'ox-html)"
              
    - name: Create output directory
      run: mkdir -p dist
      
    - name: Export documents
      run: |
        export PATH="$HOME/bin:$PATH"

        # Set TinyTeX to install missing packages automatically
        export TINYTEX_INSTALL_MISSING=1

        echo "=================================="
        echo "Starting document export process"
        echo "=================================="

        # Export resume to PDF
        echo ""
        echo "üìÑ Exporting resume.org to PDF..."
        emacs --batch resume.org \
              --eval "(require 'ox-latex)" \
              --eval "(setq org-confirm-babel-evaluate nil)" \
              --eval "(setq org-latex-pdf-process '(\"pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f\" \"pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f\"))" \
              --eval "(org-latex-export-to-pdf)"

        if [ -f "resume.pdf" ]; then
            echo "‚úÖ Resume PDF generated successfully"
            ls -lh resume.pdf
        else
            echo "‚ùå ERROR: resume.pdf was not generated!"
            echo "Listing current directory:"
            ls -la
            exit 1
        fi

        # Export resume to HTML (commented out)
        # echo ""
        # echo "üìÑ Exporting resume.org to HTML..."
        # emacs --batch resume.org \
        #       --eval "(require 'ox-html)" \
        #       --eval "(setq org-confirm-babel-evaluate nil)" \
        #       --eval "(org-html-export-to-html)"

        # Export cover letter to PDF
        echo ""
        echo "üìù Exporting cover-letter.org to PDF..."
        emacs --batch cover-letter.org \
              --eval "(require 'ox-latex)" \
              --eval "(setq org-confirm-babel-evaluate nil)" \
              --eval "(setq org-latex-pdf-process '(\"pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f\" \"pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f\"))" \
              --eval "(org-latex-export-to-pdf)"

        if [ -f "cover-letter.pdf" ]; then
            echo "‚úÖ Cover letter PDF generated successfully"
            ls -lh cover-letter.pdf
        else
            echo "‚ùå ERROR: cover-letter.pdf was not generated!"
            echo "Listing current directory:"
            ls -la
            exit 1
        fi

        # Export cover letter to HTML (commented out)
        # echo ""
        # echo "üìù Exporting cover-letter.org to HTML..."
        # emacs --batch cover-letter.org \
        #       --eval "(require 'ox-html)" \
        #       --eval "(setq org-confirm-babel-evaluate nil)" \
        #       --eval "(org-html-export-to-html)"

        # Copy to dist directory with consistent naming
        echo ""
        echo "üìÇ Copying files to dist directory..."
        cp resume.pdf dist/Shreyas_Ragavan-Resume.pdf
        # cp resume.html dist/Shreyas_Ragavan-Resume.html
        cp cover-letter.pdf dist/Shreyas_Ragavan-CoverLetter.pdf
        # cp cover-letter.html dist/Shreyas_Ragavan-CoverLetter.html

        echo ""
        echo "‚úÖ Files copied successfully:"
        ls -lh dist/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: resume-documents
        path: dist/*.pdf
        retention-days: 90
        
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      if: github.ref == 'refs/heads/main'
      with:
        path: ./dist

    # - name: Deploy to GitHub Pages
    #   uses: actions/deploy-pages@v4
    #   if: github.ref == 'refs/heads/main'

    - name: Create release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: Resume Build ${{ github.run_number }}
        files: |
          dist/Shreyas_Ragavan-Resume.pdf
          dist/Shreyas_Ragavan-CoverLetter.pdf
        generate_release_notes: false
